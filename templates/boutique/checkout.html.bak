{% extends 'base.html' %}
{% load static crispy_forms_tags %}

{% block title %}Finaliser ma commande{% endblock %}

{% block extra_css %}
<style>
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    .payment-method {
        cursor: pointer;
        transition: all 0.3s;
    }
    .payment-method:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    .payment-method.selected {
        border-color: #0d6efd !important;
        background-color: rgba(13, 110, 253, 0.05);
    }
    .order-summary-item {
        border-bottom: 1px solid #eee;
        padding: 1rem 0;
    }
    .order-summary-item:last-child {
        border-bottom: none;
    }
    .stripe-payment-element {
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
        background-color: #f8f9fa;
    }
    #card-errors {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12 mb-4">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'boutique:home' %}">Accueil</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'boutique:cart' %}">Panier</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Commande</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">Finaliser ma commande</h1>
            <p class="text-muted">Remplissez les informations ci-dessous pour finaliser votre commande</p>
        </div>
    </div>

    <form id="checkout-form" method="post" action="{% url 'boutique:checkout' %}" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <!-- Informations de livraison -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">1. Informations de livraison</h2>
                    </div>
                    <div class="card-body">
                        {% if user.is_authenticated %}
                            <div class="mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="use-default-address" checked>
                                    <label class="form-check-label" for="use-default-address">
                                        Utiliser mes informations enregistrées
                                    </label>
                                </div>
                            </div>
                        {% endif %}
                        
                        <div id="shipping-fields">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    {{ form.first_name|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.last_name|as_crispy_field }}
                                </div>
                                <div class="col-12">
                                    {{ form.email|as_crispy_field }}
                                </div>
                                <div class="col-12">
                                    {{ form.phone|as_crispy_field }}
                                </div>
                                <div class="col-12">
                                    {{ form.address|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.postal_code|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.city|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.country|as_crispy_field }}
                                </div>
                                <div class="col-12">
                                    {{ form.shipping_notes|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Méthode de livraison -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">2. Méthode de livraison</h2>
                    </div>
                    <div class="card-body">
                        {% for shipping_method in shipping_methods %}
                        <div class="form-check mb-3">
                            <input class="form-check-input shipping-method" 
                                   type="radio" 
                                   name="shipping_method" 
                                   id="shipping-{{ shipping_method.id }}" 
                                   value="{{ shipping_method.id }}" 
                                   {% if forloop.first %}checked{% endif %} 
                                   data-price="{{ shipping_method.price }}">
                            <label class="form-check-label d-flex justify-content-between w-100" for="shipping-{{ shipping_method.id }}">
                                <div>
                                    <strong>{{ shipping_method.name }}</strong>
                                    <p class="mb-0 text-muted small">{{ shipping_method.description }}</p>
                                    <p class="mb-0 small">Délai de livraison: {{ shipping_method.delivery_time }}</p>
                                </div>
                                <div class="text-nowrap ms-3">
                                    {% if shipping_method.price > 0 %}
                                        {{ shipping_method.price }} €
                                    {% else %}
                                        <span class="text-success">Gratuit</span>
                                    {% endif %}
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Paiement -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">3. Paiement</h2>
                    </div>
                    <div class="card-body">
                        <!-- Carte de crédit -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input payment-option" type="radio" name="payment_method" id="credit-card" value="credit_card" checked>
                                <label class="form-check-label fw-bold" for="credit-card">
                                    <i class="far fa-credit-card me-2"></i>Carte de crédit
                                </label>
                            </div>
                            
                            <div id="credit-card-fields" class="mt-3 ps-4">
                                <div id="card-element" class="stripe-payment-element">
                                    <!-- Un élément de carte Stripe sera inséré ici. -->
                                </div>
                                <div id="card-errors" role="alert"></div>
                                
                                <div class="d-flex align-items-center mt-2">
                                    <img src="{% static 'img/payment/visa.png' %}" alt="Visa" height="30" class="me-2">
                                    <img src="{% static 'img/payment/mastercard.png' %}" alt="Mastercard" height="30" class="me-2">
                                    <img src="{% static 'img/payment/amex.png' %}" alt="American Express" height="30">
                                </div>
                            </div>
                        </div>
                        
                        <!-- PayPal -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input payment-option" type="radio" name="payment_method" id="paypal" value="paypal">
                                <label class="form-check-label fw-bold" for="paypal">
                                    <i class="fab fa-paypal me-2"></i>PayPal
                                </label>
                            </div>
                            <div id="paypal-button-container" class="mt-3 ps-4 d-none">
                                <p class="text-muted small">Vous serez redirigé vers PayPal pour finaliser votre paiement de manière sécurisée.</p>
                            </div>
                        </div>
                        
                        <!-- Virement bancaire -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input payment-option" type="radio" name="payment_method" id="bank-transfer" value="bank_transfer">
                                <label class="form-check-label fw-bold" for="bank-transfer">
                                    <i class="fas fa-university me-2"></i>Virement bancaire
                                </label>
                            </div>
                            <div id="bank-transfer-details" class="mt-3 ps-4 d-none">
                                <p class="mb-2">Effectuez votre virement aux coordonnées bancaires suivantes :</p>
                                <ul class="list-unstyled">
                                    <li><strong>Bénéficiaire :</strong> {{ bank_details.name }}</li>
                                    <li><strong>IBAN :</strong> {{ bank_details.iban }}</li>
                                    <li><strong>BIC :</strong> {{ bank_details.bic }}</li>
                                    <li><strong>Banque :</strong> {{ bank_details.bank_name }}</li>
                                </ul>
                                <p class="mb-0 small text-muted">Votre commande sera traitée dès réception du paiement.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Commentaires -->
                <div class="card mb-4 d-none d-md-block">
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">4. Commentaires sur la commande</h2>
                    </div>
                    <div class="card-body">
                        {{ form.order_notes|as_crispy_field }}
                    </div>
                </div>
            </div>
            
            <!-- Récapitulatif de la commande -->
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h2 class="h5 mb-0">Votre commande</h2>
                    </div>
                    <div class="card-body">
                        <div class="order-summary">
                            {% for item in cart_items %}
                            <div class="order-summary-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="d-flex">
                                        <div class="me-3" style="width: 60px;">
                                            <img src="{{ item.product.image.url|default:'https://via.placeholder.com/60' }}" 
                                                 alt="{{ item.product.name }}" 
                                                 class="img-fluid rounded"
                                                 style="max-height: 60px; object-fit: contain;">
                                        </div>
                                        <div>
                                            <h6 class="mb-1">{{ item.product.name }}</h6>
                                            <p class="small text-muted mb-0">
                                                Qté: {{ item.quantity }}
                                                {% if item.variant %}
                                                    <br>{{ item.variant.name }}
                                                {% endif %}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold">{{ item.get_total_price }} €</div>
                                        {% if item.get_discounted_price < item.product.price %}
                                            <small class="text-muted text-decoration-line-through">{{ item.product.price }} €</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <hr>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Sous-total</span>
                                <span data-subtotal>{{ cart.get_subtotal }} €</span>
                            </div>
                            
                            {% if cart.discount_amount > 0 %}
                            <div class="d-flex justify-content-between mb-2 text-success">
                                <span>Réduction ({{ cart.discount_code }})</span>
                                <span data-discount>-{{ cart.discount_amount }} €</span>
                            </div>
                            {% endif %}
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span>Livraison</span>
                                <span data-shipping>
                                    {% if cart.get_shipping_cost == 0 %}
                                        <span class="text-success">Gratuit</span>
                                    {% else %}
                                        {{ cart.get_shipping_cost }} €
                                    {% endif %}
                                </span>
                            </div>
                            
                            {% if cart.tax_amount > 0 %}
                            <div class="d-flex justify-content-between mb-2 small text-muted">
                                <span>TVA ({{ cart.tax_rate }}%)</span>
                                <span data-tax>{{ cart.tax_amount }} €</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <strong>Total TTC</strong>
                            <strong class="h5 mb-0 text-primary" data-total>{{ cart.get_total }} €</strong>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="terms" required>
                            <label class="form-check-label small" for="terms">
                                J'ai lu et j'accepte les <a href="#" class="text-decoration-none">conditions générales de vente</a> et la <a href="#" class="text-decoration-none">politique de confidentialité</a>.
                            </label>
                        </div>
                        
                        <button type="submit" id="submit-button" class="btn btn-primary btn-lg w-100">
                            <span class="spinner-border spinner-border-sm d-none" id="spinner" role="status" aria-hidden="true"></span>
                            <span id="button-text">Payer maintenant</span>
                        </button>
                        
                        <p class="small text-muted mt-3 mb-0">
                            <i class="fas fa-lock me-2"></i>Paiement sécurisé
                        </p>
                    </div>
                </div>
                
                <!-- Aide et sécurité -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-light rounded-circle p-2 me-3">
                                <i class="fas fa-shield-alt text-primary"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">Paiement sécurisé</h6>
                                <small class="text-muted">Vos données sont protégées</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-light rounded-circle p-2 me-3">
                                <i class="fas fa-undo-alt text-primary"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">Retour facile</h6>
                                <small class="text-muted">30 jours pour changer d'avis</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded-circle p-2 me-3">
                                <i class="fas fa-headset text-primary"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">Service client</h6>
                                <small class="text-muted">Assistance 7j/7</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Inclure Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>

<script>
// Initialiser Stripe avec votre clé publique
const stripe = Stripe('{{ STRIPE_PUBLIC_KEY }}');

// Configuration des éléments de paiement Stripe
elements = stripe.elements({
    locale: 'fr',
    fonts: [
        {
            cssSrc: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap',
        },
    ],
    appearance: {
        theme: 'stripe',
        variables: {
            colorPrimary: '#0d6efd',
            colorBackground: '#ffffff',
            colorText: '#212529',
            colorDanger: '#dc3545',
            fontFamily: '"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
            spacingUnit: '4px',
            borderRadius: '4px',
        },
    },
});

// Créer et monter l'élément de carte
const cardElement = elements.create('card', {
    style: {
        base: {
            iconColor: '#0d6efd',
            color: '#212529',
            fontWeight: '400',
            fontFamily: '"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
            fontSize: '16px',
            fontSmoothing: 'antialiased',
            ':-webkit-autofill': {
                color: '#212529',
            },
            '::placeholder': {
                color: '#6c757d',
            },
        },
        invalid: {
            iconColor: '#dc3545',
            color: '#dc3545',
        },
    },
    hidePostalCode: false,
});

cardElement.mount('#card-element');

// Gestion des erreurs de la carte
cardElement.on('change', function(event) {
    const displayError = document.getElementById('card-errors');
    if (event.error) {
        displayError.textContent = event.error.message;
    } else {
        displayError.textContent = '';
    }
});

// Gestion de la soumission du formulaire
const form = document.getElementById('checkout-form');

// Gestion du changement de méthode de paiement
document.querySelectorAll('.payment-option').forEach(radio => {
    radio.addEventListener('change', function() {
        // Masquer tous les conteneurs de méthode de paiement
        document.querySelectorAll('[id$="-fields"], [id$="-details"]').forEach(container => {
            container.classList.add('d-none');
        });
        
        // Afficher le conteneur de la méthode sélectionnée
        const selectedMethod = this.value;
        if (selectedMethod === 'credit_card') {
            document.getElementById('credit-card-fields').classList.remove('d-none');
        } else if (selectedMethod === 'paypal') {
            document.getElementById('paypal-button-container').classList.remove('d-none');
        } else if (selectedMethod === 'bank_transfer') {
            document.getElementById('bank-transfer-details').classList.remove('d-none');
        }
    });
});

// Gestion de la soumission du formulaire
form.addEventListener('submit', async function(event) {
    event.preventDefault();
    
    // Désactiver le bouton de soumission pour éviter les soumissions multiples
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');
    
    submitButton.disabled = true;
    buttonText.textContent = 'Traitement en cours...';
    spinner.classList.remove('d-none');
    
    // Vérifier si le formulaire est valide
    if (!form.checkValidity()) {
        event.stopPropagation();
        form.classList.add('was-validated');
        submitButton.disabled = false;
        buttonText.textContent = 'Payer maintenant';
        spinner.classList.add('d-none');
        return;
    }
    
    // Récupérer la méthode de paiement sélectionnée
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    
    if (!paymentMethod) {
        // Aucune méthode de paiement sélectionnée
        const errorElement = document.getElementById('card-errors');
        errorElement.textContent = 'Veuillez sélectionner une méthode de paiement';
        errorElement.style.display = 'block';
        submitButton.disabled = false;
        buttonText.textContent = 'Payer maintenant';
        spinner.classList.add('d-none');
        return;
    }
    
    const paymentMethodValue = paymentMethod.value;
    
    // Si c'est un paiement par carte de crédit, utiliser Stripe
    if (paymentMethodValue === 'credit_card') {
        try {
            // Créer un token de paiement avec Stripe
            const { paymentMethod: stripePaymentMethod, error } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
                billing_details: {
                    name: document.getElementById('id_first_name').value + ' ' + document.getElementById('id_last_name').value,
                    email: document.getElementById('id_email').value,
                    phone: document.getElementById('id_phone').value,
                    address: {
                        line1: document.getElementById('id_address').value,
                        city: document.getElementById('id_city').value,
                        postal_code: document.getElementById('id_postal_code').value,
                        country: 'FR',
                    },
                },
            });
            
            if (error) {
                throw error;
            }
            
            // Ajouter le jeton de paiement au formulaire
            const paymentMethodInput = document.createElement('input');
            paymentMethodInput.type = 'hidden';
            paymentMethodInput.name = 'stripe_payment_method';
            paymentMethodInput.value = stripePaymentMethod.id;
            form.appendChild(paymentMethodInput);
            
            // Soumettre le formulaire
            form.submit();
            
        } catch (error) {
            // Afficher l'erreur à l'utilisateur
            const errorElement = document.getElementById('card-errors');
            errorElement.textContent = error.message;
            errorElement.style.display = 'block';
            
            // Faire défiler jusqu'à l'erreur
            errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Réactiver le bouton
            submitButton.disabled = false;
            buttonText.textContent = 'Payer maintenant';
            spinner.classList.add('d-none');
        }
    } else if (paymentMethodValue === 'paypal') {
        // Rediriger vers PayPal ou gérer le paiement PayPal
        window.location.href = "{% url 'boutique:paypal_payment' %}";
    } else {
        // Pour les autres méthodes de paiement, soumettre le formulaire normalement
        form.submit();
    }
});

// Initialisation de la page
document.addEventListener('DOMContentLoaded', function() {
    // Activer les tooltips Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Sélectionner la première méthode de paiement par défaut
    const firstPaymentMethod = document.querySelector('.payment-option');
    if (firstPaymentMethod) {
        firstPaymentMethod.checked = true;
        firstPaymentMethod.dispatchEvent(new Event('change'));
    }
    
    // Gestion de la soumission du formulaire
    const form = document.getElementById('checkout-form');
    if (form) {
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
    
    // Désactiver le bouton de soumission pour éviter les soumissions multiples
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');
    
    submitButton.disabled = true;
    buttonText.textContent = 'Traitement en cours...';
    spinner.classList.remove('d-none');
    
    // Récupérer le jeton de paiement de Stripe
    const { paymentMethod, error } = await stripe.createPaymentMethod({
        type: 'card',
        card: cardElement,
        billing_details: {
            name: '{{ form.first_name.value }} {{ form.last_name.value }}',
            email: '{{ form.email.value }}',
            phone: '{{ form.phone.value }}',
            address: {
                line1: '{{ form.address.value }}',
                city: '{{ form.city.value }}',
                postal_code: '{{ form.postal_code.value }}',
                country: 'FR',
            }
        }
    });
    
    if (error) {
        // Afficher l'erreur à l'utilisateur
        const errorElement = document.getElementById('card-errors');
        errorElement.textContent = error.message;
        
        // Réactiver le bouton
        submitButton.disabled = false;
        buttonText.textContent = 'Payer maintenant';
        spinner.classList.add('d-none');
    } else {
        // Ajouter le jeton de paiement au formulaire et le soumettre
        const paymentMethodInput = document.createElement('input');
        paymentMethodInput.type = 'hidden';
        paymentMethodInput.name = 'stripe_payment_method';
        paymentMethodInput.value = paymentMethod.id;
        form.appendChild(paymentMethodInput);
        
        // Soumettre le formulaire
        form.submit();
    }
    // Vérifier si le formulaire est valide
    if (!form.checkValidity()) {
        event.stopPropagation();
        form.classList.add('was-validated');
        submitButton.disabled = false;
        buttonText.textContent = 'Payer maintenant';
        spinner.classList.add('d-none');
        return;
        return;
    }
    
    // Récupérer la méthode de paiement sélectionnée
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
    
    // Si c'est un paiement par carte de crédit, utiliser Stripe
    if (paymentMethod === 'credit_card') {
        try {
            // Créer un token de paiement avec Stripe
            const { paymentMethod, error } = await stripe.createPaymentMethod({
                type: 'card',
                card: cardElement,
                billing_details: {
                    name: document.getElementById('id_first_name').value + ' ' + document.getElementById('id_last_name').value,
                    email: document.getElementById('id_email').value,
                    phone: document.getElementById('id_phone').value,
                    address: {
                        line1: document.getElementById('id_address').value,
                        city: document.getElementById('id_city').value,
                        postal_code: document.getElementById('id_postal_code').value,
                        country: document.getElementById('id_country').value,
                    },
                },
            });
            
            if (error) {
                // Afficher l'erreur
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = error.message;
                
                // Réactiver le bouton
                submitButton.disabled = false;
                buttonText.textContent = 'Payer maintenant';
                spinner.classList.add('d-none');
            } else {
                // Ajouter le payment_method_id au formulaire
                const paymentMethodInput = document.createElement('input');
                paymentMethodInput.setAttribute('type', 'hidden');
                paymentMethodInput.setAttribute('name', 'stripe_payment_method_id');
                paymentMethodInput.setAttribute('value', paymentMethod.id);
                form.appendChild(paymentMethodInput);
                
                // Soumettre le formulaire
                form.submit();
            }
        } catch (error) {
            console.error('Erreur:', error);
            showAlert('Une erreur est survenue lors du traitement de votre paiement. Veuillez réessayer.', 'danger');
            
            // Réactiver le bouton
            submitButton.disabled = false;
            buttonText.textContent = 'Payer maintenant';
            spinner.classList.add('d-none');
        }
    } else if (paymentMethod === 'paypal') {
        // Rediriger vers PayPal ou gérer le paiement PayPal
        // Note: L'implémentation complète nécessite l'API PayPal
        window.location.href = "{% url 'boutique:paypal_payment' %}";
    } else {
        // Pour les virements bancaires, soumettre simplement le formulaire
        form.submit();
    }
});

// Gestion du changement de méthode de paiement
document.querySelectorAll('.payment-option').forEach(radio => {
    radio.addEventListener('change', function() {
        // Masquer tous les conteneurs de méthode de paiement
        document.querySelectorAll('[id$="-fields"], [id$="-details"]').forEach(container => {
            container.classList.add('d-none');
        });
        
        // Afficher le conteneur de la méthode sélectionnée
        const selectedMethod = this.value;
        if (selectedMethod === 'credit_card') {
            document.getElementById('credit-card-fields').classList.remove('d-none');
        } else if (selectedMethod === 'paypal') {
            document.getElementById('paypal-button-container').classList.remove('d-none');
        } else if (selectedMethod === 'bank_transfer') {
            document.getElementById('bank-transfer-details').classList.remove('d-none');
        }
    });
});

// Gestion du changement de méthode de livraison
document.querySelectorAll('.shipping-method').forEach(radio => {
    radio.addEventListener('change', function() {
        // Mettre à jour les frais de livraison via AJAX
        const shippingMethodId = this.value;
        const shippingPrice = parseFloat(this.getAttribute('data-price'));
        
        // Mettre à jour l'affichage des frais de livraison
        const shippingElement = document.querySelector('[data-shipping]');
        if (shippingPrice > 0) {
            shippingElement.innerHTML = `${shippingPrice.toFixed(2)} €`;
        } else {
            shippingElement.innerHTML = '<span class="text-success">Gratuit</span>';
        }
        
        // Mettre à jour le total via AJAX (simplifié pour l'exemple)
        updateOrderTotal(shippingPrice);
    });
});

// Fonction pour mettre à jour le total de la commande
function updateOrderTotal(shippingPrice) {
    // Récupérer le sous-total du panier
    const subtotal = parseFloat('{{ cart.get_subtotal }}');
    const discount = parseFloat('{{ cart.discount_amount|default:0 }}');
    const taxRate = parseFloat('{{ cart.tax_rate|default:0 }}') / 100;
    
    // Calculer le total
    let total = subtotal - discount + shippingPrice;
    const taxAmount = total * taxRate;
    total += taxAmount;
    
    // Mettre à jour l'affichage
    document.querySelector('[data-shipping]').textContent = 
        shippingPrice > 0 ? `${shippingPrice.toFixed(2)} €` : 'Gratuit';
    
    document.querySelector('[data-total]').textContent = `${total.toFixed(2)} €`;
    
    // Mettre à jour la TVA si applicable
    const taxElement = document.querySelector('[data-tax]');
    if (taxElement) {
        taxElement.textContent = `${taxAmount.toFixed(2)} €`;
    }
}

// Gestion de l'utilisation de l'adresse par défaut
const useDefaultAddressCheckbox = document.getElementById('use-default-address');
const shippingFields = document.getElementById('shipping-fields');

if (useDefaultAddressCheckbox) {
    useDefaultAddressCheckbox.addEventListener('change', function() {
        const fields = shippingFields.querySelectorAll('input, select, textarea');
        
        if (this.checked) {
            // Désactiver les champs et les remplir avec les valeurs par défaut
            fields.forEach(field => {
                field.disabled = true;
                // Ici, vous devriez remplir les champs avec les informations de l'utilisateur connecté
                // Par exemple : field.value = '{{ user.profile.address }}';
            });
        } else {
            // Réactiver les champs
            fields.forEach(field => {
                field.disabled = false;
            });
        }
    });
    
    // Déclencher l'événement change au chargement de la page
    useDefaultAddressCheckbox.dispatchEvent(new Event('change'));
}

// Fonction pour afficher des messages d'alerte
function showAlert(message, type = 'info') {
    // Créer l'élément d'alerte
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Ajouter l'alerte en haut de la page
    const container = document.querySelector('.container.py-5');
    if (container) {
        container.prepend(alertDiv);
        
        // Supprimer l'alerte après 5 secondes
        setTimeout(() => {
            const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
            if (alert) {
                alert.close();
            }
        }, 5000);
    }
}

// Initialisation de la page
document.addEventListener('DOMContentLoaded', function() {
    // Activer les tooltips Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Activer les popovers Bootstrap
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
    
    // Initialiser le mode de paiement par défaut
    const defaultPaymentMethod = document.querySelector('input[name="payment_method"]:checked');
    if (defaultPaymentMethod) {
        defaultPaymentMethod.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
