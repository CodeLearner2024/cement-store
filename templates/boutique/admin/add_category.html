{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans 'Ajouter une catégorie' %} - {% trans 'Administration' %}{% endblock %}

{% block extra_css %}
<style>
    .image-preview {
        max-width: 300px;
        max-height: 200px;
        margin-top: 10px;
        display: none;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
    }
    .upload-area:hover {
        border-color: #0d6efd;
        background-color: #f1f8ff;
    }
    .upload-area i {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }
    .character-count {
        font-size: 0.8rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-layer-group text-primary me-2"></i>{% trans 'Nouvelle catégorie' %}
                </h2>
                <a href="{% url 'boutique:admin_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>{% trans 'Retour au tableau de bord' %}
                </a>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom py-3">
                    
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Nom de la catégorie -->
                        <div class="mb-4">
                            <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">
                                {{ form.name.label }}
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                <input type="text" 
                                       class="form-control {% if form.name.errors %}is-invalid{% endif %}" 
                                       id="{{ form.name.id_for_label }}" 
                                       name="{{ form.name.name }}" 
                                       value="{{ form.name.value|default:'' }}" 
                                       placeholder="{% trans 'Entrez le nom de la catégorie' %}" 
                                       required>
                            </div>
                            {% if form.name.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.name.errors.0 }}
                                </div>
                            {% endif %}
                        
                        </div>

                        <!-- Image de la catégorie -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                {{ form.image.label }}
                                <span class="text-muted small">({% trans 'Optionnel' %})</span>
                            </label>
                            
                            <div class="upload-area mb-3" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h5>{% trans 'Glissez et déposez votre image ici' %}</h5>
                                <p class="text-muted">
                                    {% trans 'ou cliquez pour sélectionner un fichier' %}
                                    <br>
                                    <span class="small">{% trans 'Formats supportés : JPG, PNG, WEBP (max. 5 Mo)' %}</span>
                                </p>
                                {{ form.image }}
                            </div>
                            
                            <div class="text-center">
                                <img id="imagePreview" class="img-fluid image-preview" src="#" alt="{% trans 'Aperçu de l\'image' %}">
                            </div>
                            
                            {% if form.image.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.image.errors.0 }}
                                </div>
                            {% endif %}
                
                        </div>

                        <!-- Description de la catégorie -->
                        <div class="mb-4">
                            <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                                {{ form.description.label }}
                                <span class="text-muted small">({% trans 'Optionnel' %})</span>
                            </label>
                            <div class="position-relative">
                                <textarea class="form-control {% if form.description.errors %}is-invalid{% endif %}" 
                                          id="{{ form.description.id_for_label }}" 
                                          name="{{ form.description.name }}" 
                                          rows="4" 
                                          placeholder="{% trans 'Décrivez cette catégorie en quelques mots...' %}">{{ form.description.value|default:'' }}</textarea>
                                <div class="character-count text-end mt-1">
                                    <span id="charCount">0</span>/500
                                </div>
                            </div>
                            {% if form.description.errors %}
                                <div class="invalid-feedback d-block">
                                    <i class="fas fa-exclamation-circle me-1"></i>{{ form.description.errors.0 }}
                                </div>
                            {% endif %}
                    
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'boutique:admin_dashboard' %}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-1"></i>{% trans 'Annuler' %}
                            </a>
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-save me-1"></i>{% trans 'Enregistrer la catégorie' %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gestion de l'aperçu de l'image
        const imageInput = document.getElementById('{{ form.image.id_for_label }}');
        const imagePreview = document.getElementById('imagePreview');
        const uploadArea = document.getElementById('uploadArea');
        
        // Gestion du glisser-déposer
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            uploadArea.classList.add('border-primary');
            uploadArea.style.borderStyle = 'solid';
            uploadArea.style.backgroundColor = '#e7f1ff';
        }

        function unhighlight() {
            uploadArea.classList.remove('border-primary');
            uploadArea.style.borderStyle = 'dashed';
            uploadArea.style.backgroundColor = '#f8f9fa';
        }

        // Gestion du dépôt de fichier
        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // Gestion de la sélection de fichier
        imageInput.addEventListener('change', function() {
            handleFiles(this.files);
        });

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                
                // Vérification du type de fichier
                const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert('Veuillez sélectionner une image au format JPG, PNG ou WEBP.');
                    return;
                }
                
                // Vérification de la taille du fichier (max 5 Mo)
                if (file.size > 5 * 1024 * 1024) {
                    alert('La taille du fichier ne doit pas dépasser 5 Mo.');
                    return;
                }
                
                // Affichage de l'aperçu
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        // Compteur de caractères pour la description
        const descriptionTextarea = document.getElementById('{{ form.description.id_for_label }}');
        const charCount = document.getElementById('charCount');
        
        if (descriptionTextarea && charCount) {
            // Mettre à jour le compteur au chargement
            charCount.textContent = descriptionTextarea.value.length;
            
            // Mettre à jour le compteur lors de la saisie
            descriptionTextarea.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });
        }
        
        // Validation du formulaire
        const form = document.querySelector('form.needs-validation');
        if (form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        }
    });
</script>
{% endblock %}
